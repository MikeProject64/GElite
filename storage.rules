rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Rule for service order attachments
    match /serviceOrders/{orderId}/{fileName} {
      allow read: if request.auth != null;
      
      // Allow write (upload) only if the user is authenticated and
      // the corresponding service order document in Firestore exists
      // and has a 'userId' field that matches the user's UID.
      allow write: if request.auth != null
                   && exists(/databases/$(database)/documents/serviceOrders/$(orderId))
                   && get(/databases/$(database)/documents/serviceOrders/$(orderId)).data.userId == request.auth.uid;
    }
  }
}
