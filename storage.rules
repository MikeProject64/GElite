
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Service Order Attachments
    match /serviceOrders/{orderId}/{fileName} {
      // Allow read access for the user who owns the service order.
      allow read: if request.auth != null &&
                   exists(/databases/$(database)/documents/serviceOrders/$(orderId)) &&
                   get(/databases/$(database)/documents/serviceOrders/$(orderId)).data.userId == request.auth.uid;
      
      // Allow write access (uploads/deletes) for the user who owns the service order.
      allow write: if request.auth != null &&
                    exists(/databases/$(database)/documents/serviceOrders/$(orderId)) &&
                    get(/databases/$(database)/documents/serviceOrders/$(orderId)).data.userId == request.auth.uid;
    }
  }
}

    