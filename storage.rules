rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Rule for service order attachments.
    match /serviceOrders/{orderId}/{fileName} {
      // Allow read and write if the user is authenticated and is the owner of the corresponding service order.
      // The `exists()` check is crucial to prevent race conditions where the rule runs before the Firestore document is fully created/propagated.
      allow read, write: if request.auth != null &&
                           exists(/databases/$(database)/documents/serviceOrders/$(orderId)) &&
                           get(/databases/$(database)/documents/serviceOrders/$(orderId)).data.userId == request.auth.uid;
    }
  }
}
